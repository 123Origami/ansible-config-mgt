pipeline {
    agent any

    parameters {
        string(
            name: 'inventory',
            defaultValue: 'dev',
            description: 'This is the inventory file for the environment to deploy configuration'
        )
        string(
            name: 'tags',
            defaultValue: 'all',
            description: 'Ansible tags to run (comma separated)'
        )
    }

    environment {
        ANSIBLE_CONFIG = "${WORKSPACE}/deploy/.ansible.cfg"
        INVENTORY_FILE = "${params.inventory}"
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Code') {
            steps {
                git branch: 'main', 
                url: 'https://github.com/123Origami/ansible-config-mgt.git'
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    // Update ansible.cfg with dynamic roles_path
                    sh '''
                    echo "=== Setting up environment ==="
                    echo "Inventory: ${inventory}"
                    echo "Tags: ${tags}"
                    echo "ANSIBLE_CONFIG: ${ANSIBLE_CONFIG}"
                    
                    # Update ansible.cfg with current workspace
                    sed -i "s|\\\$WORKSPACE|${WORKSPACE}|g" deploy/.ansible.cfg
                    sed -i "s|\\\$INVENTORY_FILE|${inventory}|g" deploy/.ansible.cfg
                    
                    echo "=== Updated .ansible.cfg ==="
                    cat deploy/.ansible.cfg
                    '''
                }
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                sh '''
                echo "=== Running Ansible Playbook ==="
                echo "Current directory: $(pwd)"
                echo "Inventory file: ${inventory}"
                
                # Test if inventory file exists
                if [ -f "${inventory}" ]; then
                    echo "Inventory file content:"
                    cat "${inventory}"
                else
                    echo "ERROR: Inventory file ${inventory} not found!"
                    exit 1
                fi
                
                # Run Ansible
                echo ""
                echo "Running ansible-playbook..."
                ansible-playbook -i ${inventory} site.yml --tags "${tags}" -v
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                echo "‚úÖ Deployment to ${params.inventory} completed successfully!"
                sh '''
                echo "=== Verification ==="
                date
                echo "All tasks completed!"
                '''
            }
        }
    }

    post {
        always {
            echo "üìä Pipeline ${currentBuild.currentResult}"
            echo "Inventory: ${params.inventory}"
            echo "Tags: ${params.tags}"
        }
        success {
            echo "üéâ SUCCESS! Ansible deployment completed!"
        }
        failure {
            echo "‚ùå FAILURE! Check Ansible logs above."
        }
    }
}
