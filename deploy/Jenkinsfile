pipeline {
    agent any

    parameters {
        choice(
            name: 'inventory',
            choices: ['local-test', 'dev', 'sit', 'uat', 'pentest', 'pre-prod', 'prod'],
            description: 'Select inventory file'
        )
        choice(
            name: 'tags',
            choices: ['all', 'local-setup', 'webserver-sim', 'nginx-sim', 'verify'],
            description: 'Select tags to run'
        )
    }

    environment {
        ANSIBLE_CONFIG = "${WORKSPACE}/deploy/.ansible.cfg"
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Code') {
            steps {
                git branch: 'main', 
                url: 'https://github.com/123Origami/ansible-config-mgt.git'
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    echo "ğŸš€ Starting Jenkins Pipeline"
                    echo "Inventory: ${params.inventory}"
                    echo "Tags: ${params.tags}"
                    echo "Workspace: ${WORKSPACE}"
                    
                    sh '''
                    echo "=== Environment Setup ==="
                    echo "Python: $(python3 --version)"
                    echo "Ansible: $(ansible --version | head -1)"
                    echo "Current user: $(whoami)"
                    '''
                }
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                script {
                    echo "ğŸ¯ Running Ansible Playbook"
                    
                    sh """
                    echo "=== Inventory Check ==="
                    if [ -f "${params.inventory}" ]; then
                        echo "Using inventory: ${params.inventory}"
                        echo "First few lines:"
                        head -20 "${params.inventory}"
                    else
                        echo "WARNING: Inventory file ${params.inventory} not found!"
                        echo "Using local-test instead"
                        INVENTORY_FILE="local-test"
                    fi
                    
                    echo ""
                    echo "=== Running Ansible ==="
                    echo "Command: ansible-playbook -i ${params.inventory} site.yml --tags \"${params.tags}\""
                    
                    # Run ansible-playbook
                    ansible-playbook -i ${params.inventory} site.yml --tags "${params.tags}" -v
                    """
                }
            }
        }

        stage('Verify Results') {
            steps {
                script {
                    echo "âœ… Verification Stage"
                    
                    sh '''
                    echo "=== Checking Results ==="
                    echo "Looking for success files..."
                    
                    # Check for success files
                    if [ -f "/tmp/ansible-jenkins-success.txt" ]; then
                        echo "Success file found:"
                        cat /tmp/ansible-jenkins-success.txt
                    fi
                    
                    # List recent test files
                    echo ""
                    echo "Recent test files in /tmp:"
                    ls -la /tmp/jenkins-test-* 2>/dev/null || echo "No test files found"
                    ls -la /tmp/*ansible* 2>/dev/null || echo "No ansible files found"
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "ğŸ“Š Pipeline ${currentBuild.currentResult}"
            echo "â° Build: ${currentBuild.fullDisplayName}"
            echo "ğŸ“ Workspace: ${WORKSPACE}"
        }
        success {
            echo "ğŸ‰ SUCCESS! Pipeline completed successfully!"
            echo "âœ… Ansible simulation worked perfectly!"
            
            sh '''
            echo "=== Success Summary ==="
            echo "1. Jenkinsfile syntax: âœ“"
            echo "2. Git checkout: âœ“"
            echo "3. Ansible execution: âœ“"
            echo "4. Local simulation: âœ“"
            date
            '''
        }
        failure {
            echo "âŒ FAILURE! Check logs above."
            echo "ğŸ’¡ Tip: Make sure ansible is installed on Jenkins server"
        }
    }
}
