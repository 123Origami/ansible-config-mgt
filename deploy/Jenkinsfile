pipeline {
    agent any

    parameters {
        choice(
            name: 'inventory',
            choices: ['dev', 'sit', 'uat', 'pentest', 'pre-prod', 'prod'],
            description: 'Select environment to deploy to',
            defaultValue: 'dev'
        )
        string(
            name: 'tags',
            defaultValue: 'all',
            description: 'Ansible tags to run (comma separated)'
        )
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Code') {
            steps {
                git branch: 'main', 
                url: 'https://github.com/123Origami/ansible-config-mgt.git'
            }
        }

        stage('Setup Environment') {
            steps {
                echo "Starting deployment to ${params.inventory}"
                sh '''
                echo "Working directory: \$(pwd)"
                echo "Inventory: \${inventory}"
                echo "Tags: \${tags}"
                echo ""
                echo "=== Checking files ==="
                ls -la
                '''
            }
        }

        stage('Run Ansible') {
            steps {
                sh '''
                echo "=== Running Ansible ==="
                ansible --version
                echo ""
                echo "=== Testing connectivity ==="
                if [ -f "\${inventory}" ]; then
                    ansible all -i \${inventory} -m ping -u ubuntu || echo "Ping test failed"
                else
                    echo "Inventory file \${inventory} not found"
                fi
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                echo "Deployment to \${params.inventory} completed!"
                sh '''
                echo "=== Verification ==="
                date
                echo "Deployment successful!"
                '''
            }
        }
    }

    post {
        always {
            echo "Pipeline \${currentBuild.currentResult}"
        }
        success {
            echo "SUCCESS! All stages passed!"
        }
        failure {
            echo "FAILURE! Check logs above."
        }
    }
}
