pipeline {
    agent any

    parameters {
        choice(
            name: 'inventory',
<<<<<<< HEAD
            choices: ['local-test', 'dev', 'sit', 'uat', 'pentest', 'pre-prod', 'prod'],
            description: 'Select inventory file'
=======
            defaultValue: 'dev',
            description: 'This is the inventory file for the environment to deploy configuration'
>>>>>>> 5dda3d63fd3631086b13a9716a47d0d322c1ab5b
        )
        choice(
            name: 'tags',
            choices: ['all', 'local-setup', 'webserver-sim', 'nginx-sim', 'verify'],
            description: 'Select tags to run'
        )
    }

    environment {
        ANSIBLE_CONFIG = "${WORKSPACE}/deploy/.ansible.cfg"
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Code') {
            steps {
                git branch: 'main', 
                url: 'https://github.com/123Origami/ansible-config-mgt.git'
            }
        }

        stage('Setup Environment') {
            steps {
                script {
<<<<<<< HEAD
                    echo "üöÄ Starting Jenkins Pipeline"
                    echo "Inventory: ${params.inventory}"
                    echo "Tags: ${params.tags}"
                    echo "Workspace: ${WORKSPACE}"
                    
=======
>>>>>>> 5dda3d63fd3631086b13a9716a47d0d322c1ab5b
                    sh '''
                    echo "=== Environment Setup ==="
                    echo "Python: $(python3 --version)"
                    echo "Ansible: $(ansible --version | head -1)"
                    echo "Current user: $(whoami)"
                    '''
                }
            }
        }

        stage('Run Ansible Playbook') {
            steps {
<<<<<<< HEAD
                script {
                    echo "üéØ Running Ansible Playbook"
                    
                    sh """
                    echo "=== Inventory Check ==="
                    if [ -f "${params.inventory}" ]; then
                        echo "Using inventory: ${params.inventory}"
                        echo "First few lines:"
                        head -20 "${params.inventory}"
                    else
                        echo "WARNING: Inventory file ${params.inventory} not found!"
                        echo "Using local-test instead"
                        INVENTORY_FILE="local-test"
                    fi
                    
                    echo ""
                    echo "=== Running Ansible ==="
                    echo "Command: ansible-playbook -i ${params.inventory} site.yml --tags \"${params.tags}\""
                    
                    # Run ansible-playbook
                    ansible-playbook -i ${params.inventory} site.yml --tags "${params.tags}" -v
                    """
                }
=======
                sh '''
                echo "=== Running Ansible Playbook ==="
                echo "Current directory: $(pwd)"
                echo "Inventory file: ${inventory}"
                
                # Test if inventory file exists
                if [ -f "${inventory}" ]; then
                    echo "Inventory file content:"
                    cat "${inventory}"
                else
                    echo "ERROR: Inventory file ${inventory} not found!"
                    exit 1
                fi
                
                # Run Ansible
                echo ""
                echo "Running ansible-playbook..."
                ansible-playbook -i ${inventory} site.yml --tags "${tags}" -v
                '''
>>>>>>> 5dda3d63fd3631086b13a9716a47d0d322c1ab5b
            }
        }

        stage('Verify Results') {
            steps {
<<<<<<< HEAD
                script {
                    echo "‚úÖ Verification Stage"
                    
                    sh '''
                    echo "=== Checking Results ==="
                    echo "Looking for success files..."
                    
                    # Check for success files
                    if [ -f "/tmp/ansible-jenkins-success.txt" ]; then
                        echo "Success file found:"
                        cat /tmp/ansible-jenkins-success.txt
                    fi
                    
                    # List recent test files
                    echo ""
                    echo "Recent test files in /tmp:"
                    ls -la /tmp/jenkins-test-* 2>/dev/null || echo "No test files found"
                    ls -la /tmp/*ansible* 2>/dev/null || echo "No ansible files found"
                    '''
                }
=======
                echo "‚úÖ Deployment to ${params.inventory} completed successfully!"
                sh '''
                echo "=== Verification ==="
                date
                echo "All tasks completed!"
                '''
>>>>>>> 5dda3d63fd3631086b13a9716a47d0d322c1ab5b
            }
        }
    }

    post {
        always {
            echo "üìä Pipeline ${currentBuild.currentResult}"
<<<<<<< HEAD
            echo "‚è∞ Build: ${currentBuild.fullDisplayName}"
            echo "üìÅ Workspace: ${WORKSPACE}"
=======
            echo "Inventory: ${params.inventory}"
            echo "Tags: ${params.tags}"
>>>>>>> 5dda3d63fd3631086b13a9716a47d0d322c1ab5b
        }
        success {
            echo "üéâ SUCCESS! Pipeline completed successfully!"
            echo "‚úÖ Ansible simulation worked perfectly!"
            
            sh '''
            echo "=== Success Summary ==="
            echo "1. Jenkinsfile syntax: ‚úì"
            echo "2. Git checkout: ‚úì"
            echo "3. Ansible execution: ‚úì"
            echo "4. Local simulation: ‚úì"
            date
            '''
        }
        failure {
            echo "‚ùå FAILURE! Check logs above."
            echo "üí° Tip: Make sure ansible is installed on Jenkins server"
        }
    }
}
